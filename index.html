<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Inventory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: #0d0d0d;
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .status {
            color: #00ff88;
            font-size: 1.1rem;
            font-weight: 600;
            min-height: 30px;
        }

        /* MIC BUTTON */
        .mic-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: #00ff88;
            color: #000;
            font-size: 2.5rem;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .mic-btn.listening {
            background: #ff3366;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .transcript {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 10px;
            min-height: 50px;
            color: #00ff88;
            font-size: 1.1rem;
            text-align: center;
        }

        /* CONTROLS */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .control-btn {
            flex: 1;
            padding: 15px;
            background: #1a1a1a;
            border: 2px solid #333;
            color: #fff;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .control-btn:active {
            background: #2a2a2a;
            transform: scale(0.98);
        }

        /* FORM */
        .form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .field-group {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #333;
            transition: 0.2s;
        }

        .field-group.active {
            border-left-color: #00ff88;
            background: #1f2a1f;
        }

        .field-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .field-number {
            color: #00ff88;
            font-weight: 700;
        }

        .field-input {
            width: 100%;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.4rem;
            font-weight: 600;
            outline: none;
            padding: 0;
        }

        .field-input::placeholder {
            color: #444;
        }

        /* SAVE BUTTON */
        .save-btn {
            width: 100%;
            padding: 20px;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 20px;
            transition: 0.2s;
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* LOG */
        .log {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .log-header {
            padding: 15px 20px;
            background: #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .log-count {
            background: #00ff88;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .log-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .log-items.open {
            max-height: 400px;
            overflow-y: auto;
        }

        .log-item {
            padding: 15px 20px;
            border-bottom: 1px solid #222;
        }

        .log-item-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .log-item-details {
            font-size: 0.85rem;
            color: #888;
        }

        /* HELP */
        .help {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #00ff88;
        }

        .help h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .help ul {
            list-style: none;
            line-height: 2;
            color: #aaa;
        }

        .help li::before {
            content: "‚Üí ";
            color: #00ff88;
            font-weight: 700;
        }

        .cmd {
            color: #ffaa00;
            font-weight: 700;
        }

        @media (max-width: 600px) {
            body { padding: 15px; }
            h1 { font-size: 1.5rem; }
            .mic-btn { width: 70px; height: 70px; font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Voice Inventory</h1>
            <div class="status" id="status">Click mic to start</div>
        </div>

        <div class="mic-section">
            <button class="mic-btn" id="mic-btn" onclick="toggleMic()">üé§</button>
            <div class="transcript" id="transcript">...</div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="prevField()">‚¨ÖÔ∏è Back</button>
            <button class="control-btn" onclick="nextField()">Next ‚û°Ô∏è</button>
            <button class="control-btn" onclick="clearAll()">üóëÔ∏è Clear</button>
        </div>

        <div class="form">
            <div class="field-group active" id="field-0">
                <div class="field-label">
                    <span>Product Name</span>
                    <span class="field-number">1/5</span>
                </div>
                <input type="text" class="field-input" id="input-0" placeholder="Engine Oil...">
            </div>

            <div class="field-group" id="field-1">
                <div class="field-label">
                    <span>Category</span>
                    <span class="field-number">2/5</span>
                </div>
                <input type="text" class="field-input" id="input-1" placeholder="Lubricants...">
            </div>

            <div class="field-group" id="field-2">
                <div class="field-label">
                    <span>Unit</span>
                    <span class="field-number">3/5</span>
                </div>
                <input type="text" class="field-input" id="input-2" placeholder="Bottle...">
            </div>

            <div class="field-group" id="field-3">
                <div class="field-label">
                    <span>Price (‚Ç±)</span>
                    <span class="field-number">4/5</span>
                </div>
                <input type="text" class="field-input" id="input-3" placeholder="250">
            </div>

            <div class="field-group" id="field-4">
                <div class="field-label">
                    <span>Stock Quantity</span>
                    <span class="field-number">5/5</span>
                </div>
                <input type="text" class="field-input" id="input-4" placeholder="50">
            </div>
        </div>

        <button class="save-btn" id="save-btn" onclick="saveData()">üíæ SAVE TO SHEET</button>

        <div class="log">
            <div class="log-header" onclick="toggleLog()">
                <span style="font-weight:600">üìã Saved Items</span>
                <span class="log-count" id="log-count">0</span>
            </div>
            <div class="log-items" id="log-items"></div>
        </div>

        <div class="help">
            <h3>Voice Commands</h3>
            <ul>
                <li><span class="cmd">NEXT</span> - Move to next field</li>
                <li><span class="cmd">BACK</span> - Go back to previous field</li>
                <li><span class="cmd">DONE</span> - Save item</li>
                <li><span class="cmd">CLEAR</span> - Clear all fields</li>
                <li>Just speak naturally to fill fields</li>
            </ul>
        </div>
    </div>

    <script>
        // CONFIG
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz6MKoHA1QNgDCfj42nMJgR7Ix42EuJH6vhxwa14oNUYlkJpOrXFxfa12P8VP38SJL0/exec";

        // SETUP
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("‚ö†Ô∏è Voice recognition not supported. Use Chrome.");
        }

        let recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        // STATE
        let listening = false;
        let currentField = 0;
        let saving = false;
        let savedItems = [];
        let lastCommand = '';
        let lastCommandTime = 0;

        let isAndroid = /android/i.test(navigator.userAgent);
        let micRestartAttempts = 0;
        const MAX_MIC_RESTARTS = 3;

        // ELEMENTS
        const micBtn = document.getElementById('mic-btn');
        const status = document.getElementById('status');
        const transcript = document.getElementById('transcript');
        const saveBtn = document.getElementById('save-btn');
        const logItems = document.getElementById('log-items');
        const logCount = document.getElementById('log-count');

        // ========== INITIALIZATION ==========
        function initializeApp() {
            loadItems();
            highlightField(0);
            setupRecognition();
        }

        function setupRecognition() {
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            // Clear old event listeners
            recognition.onresult = null;
            recognition.onend = null;
            recognition.onerror = null;
            
            // Set new event listeners
            recognition.onresult = handleVoiceResult;
            recognition.onend = handleRecognitionEnd;
            recognition.onerror = handleRecognitionError;
        }

        // ========== VOICE HANDLING ==========
        function handleVoiceResult(event) {
            if (saving) return;

            const result = event.results[event.results.length - 1];
            const text = result[0].transcript.trim();
            const lower = text.toLowerCase();
            const isFinal = result.isFinal;
            
            // Always show what's being heard
            transcript.textContent = text;
            
            if (isFinal) {
                const now = Date.now();
                const timeSinceLastCommand = now - lastCommandTime;
                
                // Ignore fragments that come too quickly after commands
                if (timeSinceLastCommand < 500) {
                    console.log('Ignoring post-command fragment');
                    return;
                }
                
                // Check for commands FIRST
                const words = lower.split(/\s+/);
                const lastWord = words[words.length - 1];
                
                // NEXT command
                if ((lastWord === 'next' || lastWord === 'nex' || lastWord === 'text') && 
                    (words.length <= 2 || lower.includes('go next') || lower.includes('move next'))) {
                    lastCommand = text;
                    lastCommandTime = now;
                    nextField();
                    clearTranscriptAfterDelay(text);
                    return;
                }
                
                // BACK command
                if (lastWord === 'back' || lastWord === 'previous' || 
                    lower.includes('go back') || lower.includes('move back')) {
                    lastCommand = text;
                    lastCommandTime = now;
                    prevField();
                    clearTranscriptAfterDelay(text);
                    return;
                }
                
                // CLEAR command
                if (lower.includes('clear') && (lower.includes('all') || words.length === 1)) {
                    lastCommand = text;
                    lastCommandTime = now;
                    clearAll();
                    clearTranscriptAfterDelay(text);
                    return;
                }
                
                // SAVE command
                if (lastWord === 'save' || lastWord === 'done' || 
                    lower.includes('save it') || lower.includes('all done')) {
                    lastCommand = text;
                    lastCommandTime = now;
                    saveData();
                    clearTranscriptAfterDelay(text);
                    return;
                }
                
                // If we get here, fill the current field
                fillField(text);
            }
        }

        function clearTranscriptAfterDelay(text) {
            setTimeout(() => {
                if (transcript.textContent === text) {
                    transcript.textContent = '...';
                }
            }, 300);
        }

        function handleRecognitionEnd() {
            if (listening && !saving) {
                // Don't auto-restart on Android - we handle it manually
                if (!isAndroid) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            listening = false;
                            micBtn.classList.remove('listening');
                        }
                    }, 100);
                }
            }
        }

        function handleRecognitionError(event) {
            console.log('Recognition error:', event.error);
            if (event.error === 'not-allowed') {
                alert('‚ö†Ô∏è Please allow microphone access');
                listening = false;
                micBtn.classList.remove('listening');
                status.textContent = 'Mic access denied';
            } else if (event.error === 'no-speech') {
                // This is normal - just restart
                if (listening && !saving) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Error restarting after no-speech:', e);
                        }
                    }, 100);
                }
            }
        }

        // ========== NUMBER PARSING (FIXED) ==========
        function fillField(text) {
            const input = document.getElementById(`input-${currentField}`);
            let value = text.trim();
            
            // Don't fill if empty
            if (!value || value === '...' || /^[.,!?]+$/.test(value)) {
                return;
            }
            
            // For price/stock fields: parse numbers intelligently
            if (currentField === 3 || currentField === 4) {
                const parsed = parseNumber(value);
                console.log(`Parsed "${value}" ‚Üí "${parsed}"`);
                
                if (parsed !== '' && parsed !== value) {
                    input.value = parsed;
                } else {
                    // Extract any digits as fallback
                    const digits = value.replace(/[^0-9.]/g, '');
                    input.value = digits || value;
                }
                return;
            }
            
            // For text fields: title case
            if (currentField === 0 || currentField === 2) {
                value = value.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ');
            }
            
            input.value = value;
        }

        function parseNumber(text) {
            // SIMPLIFIED AND ROBUST NUMBER PARSER
            const numberMap = {
                'zero': '0', 'oh': '0', 'o': '0',
                'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5',
                'six': '6', 'seven': '7', 'eight': '8', 'nine': '9',
                'ten': '10', 'eleven': '11', 'twelve': '12', 'thirteen': '13',
                'fourteen': '14', 'fifteen': '15', 'sixteen': '16',
                'seventeen': '17', 'eighteen': '18', 'nineteen': '19',
                'twenty': '20', 'thirty': '30', 'forty': '40', 'fifty': '50',
                'sixty': '60', 'seventy': '70', 'eighty': '80', 'ninety': '90'
            };

            let input = text.toLowerCase().trim();
            
            // Remove common filler words
            input = input.replace(/\b(and|a|the|only|just|items?|pcs?|pieces?)\b/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();

            // Direct number match
            const directNumber = input.match(/\d+/);
            if (directNumber) return directNumber[0];

            // Handle "point" for decimals
            if (input.includes('point')) {
                const parts = input.split('point');
                const whole = numberMap[parts[0].trim()] || '0';
                const decimal = parts[1].trim().split('').map(char => 
                    numberMap[char] || ''
                ).join('');
                return `${whole}.${decimal}`;
            }

            // Simple word replacement
            let result = input;
            Object.keys(numberMap).forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'g');
                result = result.replace(regex, numberMap[word]);
            });

            // Remove non-digits (except decimal point)
            result = result.replace(/[^0-9.]/g, '');
            
            return result || '';
        }

        // ========== NAVIGATION ==========
        function nextField() {
            if (currentField < 4) {
                currentField++;
                highlightField(currentField);
            }
        }

        function prevField() {
            if (currentField > 0) {
                currentField--;
                highlightField(currentField);
            }
        }

        function highlightField(index) {
            for (let i = 0; i < 5; i++) {
                document.getElementById(`field-${i}`).classList.remove('active');
            }
            document.getElementById(`field-${index}`).classList.add('active');
            document.getElementById(`field-${index}`).scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
            updateStatus();
        }

        // ========== MICROPHONE CONTROL ==========
        function toggleMic() {
            if (listening) {
                stopMic();
            } else {
                micRestartAttempts = 0;
                startMic();
            }
        }

        function startMic() {
            try {
                // Ensure fresh setup on Android
                if (isAndroid) {
                    setupRecognition();
                }
                
                recognition.start();
                listening = true;
                micBtn.classList.add('listening');
                updateStatus();
                console.log('Mic started');
            } catch (e) {
                console.log('Mic start error:', e);
            }
        }

        function stopMic() {
            try {
                recognition.stop();
            } catch (e) {}
            listening = false;
            micBtn.classList.remove('listening');
            status.textContent = 'Paused';
        }

        function updateStatus() {
            const fields = ['Product Name', 'Category', 'Unit', 'Price', 'Stock'];
            status.textContent = listening ? `üé§ ${fields[currentField]}` : 'Click mic to start';
        }

        // ========== ANDROID MIC FIX ==========
        function restartAndroidMic() {
            if (!listening || micRestartAttempts >= MAX_MIC_RESTARTS) {
                console.log('Max restart attempts reached');
                listening = false;
                micBtn.classList.remove('listening');
                return;
            }

            micRestartAttempts++;
            console.log(`Android mic restart attempt ${micRestartAttempts}`);

            // Force stop
            try {
                recognition.stop();
            } catch (e) {}

            // Fresh start
            setTimeout(() => {
                try {
                    setupRecognition();
                    recognition.start();
                    
                    setTimeout(() => {
                        if (listening) {
                            console.log('Android mic restarted successfully');
                            status.textContent = '‚úÖ Mic restored';
                            setTimeout(updateStatus, 1000);
                        }
                    }, 500);
                } catch (error) {
                    console.log('Android restart failed:', error);
                    
                    // Retry with exponential backoff
                    if (micRestartAttempts < MAX_MIC_RESTARTS) {
                        setTimeout(() => restartAndroidMic(), 1000 * micRestartAttempts);
                    }
                }
            }, 300);
        }

        // ========== DATA MANAGEMENT ==========
        function clearAll() {
            for (let i = 0; i < 5; i++) {
                document.getElementById(`input-${i}`).value = '';
            }
            currentField = 0;
            highlightField(0);
            transcript.textContent = '...';
        }

        function saveData() {
            if (saving) return;

            const data = {
                name: document.getElementById('input-0').value,
                category: document.getElementById('input-1').value,
                unit: document.getElementById('input-2').value,
                price: document.getElementById('input-3').value,
                stock: document.getElementById('input-4').value,
                timestamp: new Date().toLocaleString()
            };

            if (!data.name) {
                alert('‚ùå Product name is required!');
                currentField = 0;
                highlightField(0);
                return;
            }

            saving = true;
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ Saving...';
            status.textContent = 'Saving to Google Sheets...';

            // Save locally first
            savedItems.unshift(data);
            localStorage.setItem('inventoryItems', JSON.stringify(savedItems));
            updateLog();

            // Send to Google Sheets
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(() => {
                finishSave(data);
            })
            .catch(err => {
                console.error('Save error:', err);
                finishSave(data);
            });

            // Fallback timeout
            setTimeout(() => {
                if (saving) finishSave(data);
            }, 3000);
        }

        function finishSave(data) {
            if (!saving) return;
            saving = false;

            status.textContent = `‚úÖ Saved: ${data.name}`;
            saveBtn.textContent = 'üíæ SAVE TO SHEET';
            saveBtn.disabled = false;
            transcript.textContent = '‚úÖ Item saved!';

            // Clear fields
            clearAll();

            // Handle Android mic restart
            if (listening && isAndroid) {
                console.log('Android: Restarting mic after save');
                
                setTimeout(() => {
                    try {
                        recognition.stop();
                    } catch (e) {}
                    
                    setTimeout(() => {
                        micRestartAttempts = 0;
                        restartAndroidMic();
                    }, 500);
                }, 200);
            } else if (listening) {
                // Normal behavior for non-Android
                setTimeout(() => {
                    if (listening) {
                        updateStatus();
                        transcript.textContent = '...';
                    }
                }, 1500);
            }
        }

        // ========== LOG FUNCTIONS ==========
        function loadItems() {
            const saved = localStorage.getItem('inventoryItems');
            if (saved) {
                savedItems = JSON.parse(saved);
                updateLog();
            }
        }

        function toggleLog() {
            logItems.classList.toggle('open');
        }

        function updateLog() {
            logCount.textContent = savedItems.length;

            if (savedItems.length === 0) {
                logItems.innerHTML = '<div style="padding:20px;text-align:center;color:#666">No items yet</div>';
                return;
            }

            logItems.innerHTML = savedItems.slice(0, 20).map(item => `
                <div class="log-item">
                    <div class="log-item-name">${item.name}</div>
                    <div class="log-item-details">
                        ${item.category} ‚Ä¢ ${item.unit} ‚Ä¢ ‚Ç±${item.price} ‚Ä¢ Qty: ${item.stock}
                    </div>
                </div>
            `).join('');
        }

        // ========== START THE APP ==========
        initializeApp();
    </script>
</body>
</html>
