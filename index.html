<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Inventory (Stable)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --highlight: #00d4ff; 
            --listening: #ff4757; 
            --success: #2ed573;
            --correction: #ffa502;
            --warning: #ff7f50;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 15px;
            min-height: 100vh;
            touch-action: pan-y;
        }

        .container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

        h1 { text-align: center; font-weight: 300; margin: 0 0 10px 0; }

        /* OFFLINE BANNER */
        #offline-alert {
            background: var(--warning); color: #121212;
            padding: 12px; border-radius: 8px; margin-bottom: 15px;
            text-align: center; font-weight: bold; display: none;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        #status-text { 
            color: var(--highlight); min-height: 25px; margin-bottom: 15px;
            font-weight: bold; text-align: center;
        }

        .controls {
            display: flex; justify-content: center; margin-bottom: 20px;
        }

        #mic-btn {
            width: 80px; height: 80px; border-radius: 50%;
            border: none; background-color: #333; color: white;
            font-size: 2rem; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }
        #mic-btn.active { 
            background-color: var(--listening); 
            animation: pulse 1.5s infinite;
            transform: scale(1.1);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .transcript-box {
            background: var(--card-bg); padding: 10px; border-radius: 8px;
            margin-bottom: 20px; min-height: 50px; border: 1px solid #333;
            text-align: center;
        }
        .transcript-text { color: var(--highlight); font-size: 1.1rem; }
        .transcript-text.cmd { color: var(--correction); font-weight: bold; }

        .grid-container { display: flex; flex-direction: column; gap: 12px; }

        .input-group {
            background: var(--card-bg); padding: 12px 15px;
            border-radius: 10px; border-left: 5px solid #333; 
            transition: all 0.2s; position: relative;
        }
        .input-group.active {
            border-left-color: var(--highlight);
            background-color: #262626; transform: translateX(5px);
        }
        /* Lock visual prevents confusion during cooldown */
        .input-group.locked { opacity: 0.5; pointer-events: none; }

        .field-number {
            position: absolute; top: 10px; right: 10px;
            background: #333; color: #888; width: 24px; height: 24px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem;
        }
        .input-group.active .field-number { background: var(--highlight); color: #121212; }

        label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 5px; text-transform: uppercase; }
        input {
            width: 100%; background: transparent; border: none;
            color: white; font-size: 1.3rem; font-weight: 600; outline: none;
        }

        .button-group { display: flex; gap: 10px; margin-top: 20px; }
        .action-btn {
            flex: 1; padding: 15px; border: none; border-radius: 8px;
            font-weight: bold; font-size: 1rem; cursor: pointer;
        }
        .save-btn { background: var(--success); color: #121212; }
        .clear-btn { background: #ff4757; color: white; }

        /* LOGS */
        .log-section { background: var(--card-bg); border-radius: 10px; margin-top: 20px; }
        .log-header { padding: 15px; background: #2a2a2a; display: flex; justify-content: space-between; cursor: pointer; }
        .log-content { max-height: 0; overflow-y: auto; transition: 0.3s; }
        .log-content.open { max-height: 300px; }
        .log-item { padding: 10px; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .log-pending { border-left: 3px solid var(--warning); }
        .log-synced { border-left: 3px solid var(--success); }

        /* Helper Text */
        .cmd-list { text-align: center; color: #666; font-size: 0.8rem; margin-top: 20px; line-height: 1.6; }
        .cmd-pill { background: #333; padding: 2px 6px; border-radius: 4px; color: var(--success); }
    </style>
</head>
<body>

    <div class="container">
        <h1>Inventory Voice</h1>
        
        <div id="offline-alert" onclick="syncOfflineData()">
            ‚ö†Ô∏è <span id="pending-count">0</span> items waiting. Tap to Sync.
        </div>

        <div id="status-text">Tap mic to start</div>

        <div class="controls">
            <button id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
        </div>

        <div class="transcript-box">
            <div class="transcript-text" id="transcript">...</div>
        </div>

        <div class="grid-container">
            <div class="input-group" id="group-0" onclick="focusField(0)">
                <span class="field-number">1</span>
                <label>Product Name</label>
                <input type="text" id="input-0" placeholder="Say name...">
            </div>
            <div class="input-group" id="group-1" onclick="focusField(1)">
                <span class="field-number">2</span>
                <label>Category</label>
                <input type="text" id="input-1" placeholder="Say category...">
            </div>
            <div class="input-group" id="group-2" onclick="focusField(2)">
                <span class="field-number">3</span>
                <label>Unit</label>
                <input type="text" id="input-2" placeholder="pcs, box, kg...">
            </div>
            <div class="input-group" id="group-3" onclick="focusField(3)">
                <span class="field-number">4</span>
                <label>Price</label>
                <input type="number" id="input-3" placeholder="0.00">
            </div>
            <div class="input-group" id="group-4" onclick="focusField(4)">
                <span class="field-number">5</span>
                <label>Stock Qty</label>
                <input type="number" id="input-4" placeholder="0">
            </div>
        </div>

        <div class="button-group">
            <button class="action-btn save-btn" id="save-btn" onclick="saveItem()">üíæ SAVE (Say "Done")</button>
            <button class="action-btn clear-btn" onclick="clearForm()">üóëÔ∏è CLEAR</button>
        </div>

        <div class="log-section">
            <div class="log-header" onclick="document.getElementById('log-content').classList.toggle('open')">
                <span>üìã History</span>
                <span style="background:var(--success); color:#000; padding:2px 8px; border-radius:10px; font-size:0.8rem" id="log-count">0</span>
            </div>
            <div class="log-content" id="log-content">
                <div id="log-list"></div>
            </div>
        </div>

        <div class="cmd-list">
            Commands: <span class="cmd-pill">NEXT</span> <span class="cmd-pill">BACK</span> <span class="cmd-pill">DONE</span><br>
            Or say "Jump to Price", "Jump to Stock"
        </div>
    </div>

    <script>
        // --- PASTE YOUR GOOGLE SCRIPT URL HERE ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz0n_uNiYoFQ99JMynsQ9yWJPQDL9QIh2dI3fPzogQ7HLHeZkDuM163kpS79pgpAzB9/exec"; 

        // --- SETUP ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition ? new SpeechRecognition() : null;
        
        // DOM Elements
        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');
        const transcriptEl = document.getElementById('transcript');
        const offlineAlert = document.getElementById('offline-alert');

        // State
        let isListening = false;
        let activeIndex = 0;
        let isSaving = false;
        let commandLock = false; // The anti-jump lock
        const totalFields = 5;

        // --- COMMANDS ---
        const CMDS = {
            next: ['next', 'go', 'skip', 'forward', 'move'],
            back: ['back', 'return', 'previous', 'rear'],
            save: ['done', 'save', 'finish', 'submit'],
            clear: ['clear form', 'reset form', 'delete all'],
            jump: {
                0: ['name', 'product'], 1: ['category', 'type'], 
                2: ['unit', 'measure'], 3: ['price', 'cost'], 4: ['stock', 'qty', 'quantity']
            }
        };

        if (recognition) {
            recognition.continuous = true;
            recognition.interimResults = true; // Still true for visual feedback, handled strictly in logic
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('active');
                statusText.textContent = "üé§ Listening...";
            };

            recognition.onend = () => {
                if (isListening) recognition.start(); // Auto-restart
                else {
                    micBtn.classList.remove('active');
                    statusText.textContent = "‚è∏Ô∏è Paused";
                }
            };

            recognition.onresult = (event) => {
                // If saving or locked, ignore everything
                if (isSaving || commandLock) return;

                const result = event.results[event.results.length - 1];
                const text = result[0].transcript.toLowerCase().trim();
                const isFinal = result.isFinal;

                // 1. Show what we hear (Visual only)
                transcriptEl.textContent = text;
                transcriptEl.classList.remove('cmd');

                // 2. STRICT RULE: Commands only execute on FINAL results
                // This prevents the "Interim 'Next'" -> "Final 'Next'" double jump
                if (isFinal) {
                    if (checkCommands(text)) {
                        transcriptEl.classList.add('cmd');
                        // Clear transcript after a command
                        setTimeout(() => transcriptEl.textContent = "...", 800);
                    } else {
                        // Not a command, so it's data input
                        handleInput(text);
                    }
                }
            };
        } else {
            alert("Use Chrome browser for voice features.");
        }

        // --- LOGIC ---

        function toggleMic() {
            if (isListening) { isListening = false; recognition.stop(); }
            else { recognition.start(); }
        }

        function checkCommands(text) {
            // Check NEXT
            if (CMDS.next.some(c => text === c || text.endsWith(" " + c))) {
                moveField(1);
                return true;
            }
            // Check BACK
            if (CMDS.back.some(c => text === c)) {
                moveField(-1);
                return true;
            }
            // Check SAVE
            if (CMDS.save.some(c => text === c)) {
                saveItem();
                return true;
            }
            // Check JUMPS
            for (let [idx, triggers] of Object.entries(CMDS.jump)) {
                if (triggers.some(t => text.includes(t) && (text.includes('jump') || text.includes('go')))) {
                    focusField(parseInt(idx));
                    return true;
                }
            }
            // Check CLEAR
            if (CMDS.clear.some(c => text.includes(c))) {
                clearForm();
                return true;
            }
            return false;
        }

        function moveField(direction) {
            // Apply Lock
            activateLock();
            activeIndex = (activeIndex + direction + totalFields) % totalFields;
            focusField(activeIndex);
        }

        function focusField(index) {
            activeIndex = index;
            // UI Update
            document.querySelectorAll('.input-group').forEach(el => el.classList.remove('active'));
            const group = document.getElementById(`group-${index}`);
            group.classList.add('active');
            group.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function activateLock() {
            // Locks the voice engine for 1 second so it can't jump again immediately
            commandLock = true;
            statusText.textContent = "üîí Moving...";
            setTimeout(() => {
                commandLock = false;
                statusText.textContent = "üé§ Listening...";
            }, 1000); // 1 Second cooldown
        }

        // --- INPUT HANDLING (Better Numbers) ---
        function handleInput(text) {
            const input = document.getElementById(`input-${activeIndex}`);
            let clean = text;

            // Remove command words if they accidentally slipped in
            CMDS.next.forEach(c => clean = clean.replace(c, ''));

            if (input.type === 'number') {
                input.value = parseNumber(clean);
            } else {
                // Capitalize
                input.value = clean.charAt(0).toUpperCase() + clean.slice(1);
            }
            
            // Visual Flash
            input.style.color = 'var(--success)';
            setTimeout(() => input.style.color = 'white', 500);
        }

        function parseNumber(text) {
            let str = text.toLowerCase();
            // 1. Homophone fixes
            const map = { 'to': '2', 'too': '2', 'for': '4', 'tree': '3', 'won': '1', 'one': '1' };
            Object.keys(map).forEach(k => str = str.replace(new RegExp(`\\b${k}\\b`, 'g'), map[k]));

            // 2. Hyphens
            str = str.replace(/-/g, ' ');

            // 3. Simple text-to-digit replacement for common inventory numbers
            const nums = {
                'twenty': '20', 'thirty': '30', 'forty': '40', 'fifty': '50', 'sixty': '60',
                'ten': '10', 'eleven': '11', 'twelve': '12'
            };
            // Very basic parser: if user says "twenty five", we get "20 5" -> remove space -> "25"
            Object.keys(nums).forEach(k => str = str.replace(new RegExp(`\\b${k}\\b`, 'g'), nums[k]));

            // Remove non-digits/dots and spaces
            return str.replace(/[^0-9.]/g, ' ').replace(/\s/g, '');
        }

        // --- SAVE & OFFLINE ---
        function saveItem() {
            if (isSaving) return;

            const data = {
                name: document.getElementById('input-0').value,
                category: document.getElementById('input-1').value,
                unit: document.getElementById('input-2').value,
                price: document.getElementById('input-3').value,
                stock: document.getElementById('input-4').value,
                timestamp: new Date().toLocaleTimeString()
            };

            if (!data.name) { alert("Name required!"); return; }

            isSaving = true;
            document.getElementById('save-btn').textContent = "‚è≥...";
            
            if (navigator.onLine) {
                fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(() => finishSave(data, true))
                .catch(() => saveOffline(data)); // Fallback
            } else {
                saveOffline(data);
            }
        }

        function saveOffline(data) {
            let pending = JSON.parse(localStorage.getItem('inv_offline') || "[]");
            pending.push(data);
            localStorage.setItem('inv_offline', JSON.stringify(pending));
            finishSave(data, false);
        }

        function finishSave(data, synced) {
            // Add to log
            const list = document.getElementById('log-list');
            const div = document.createElement('div');
            div.className = `log-item ${synced ? 'log-synced' : 'log-pending'}`;
            div.innerHTML = `<b>${data.name}</b> <span style="color:#888">Qty:${data.stock}</span>`;
            list.insertBefore(div, list.firstChild);
            
            document.getElementById('log-count').textContent = list.children.length;
            
            // Check offline status
            updateOfflineUI();

            // Reset Form
            clearForm();
            isSaving = false;
            document.getElementById('save-btn').textContent = "üíæ SAVE (Say 'Done')";
            transcriptEl.textContent = "‚úÖ Saved";
            
            // Move back to start
            focusField(0);
        }

        function updateOfflineUI() {
            let pending = JSON.parse(localStorage.getItem('inv_offline') || "[]");
            if (pending.length > 0) {
                offlineAlert.style.display = 'block';
                document.getElementById('pending-count').textContent = pending.length;
            } else {
                offlineAlert.style.display = 'none';
            }
        }

        function syncOfflineData() {
            if (!navigator.onLine) return alert("Still offline!");
            
            let pending = JSON.parse(localStorage.getItem('inv_offline') || "[]");
            if (confirm(`Sync ${pending.length} items?`)) {
                // Upload one by one loop
                const uploadNext = (i) => {
                    if (i >= pending.length) {
                        localStorage.setItem('inv_offline', "[]");
                        updateOfflineUI();
                        location.reload(); // Refresh to clean slate
                        return;
                    }
                    fetch(SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pending[i])
                    }).then(() => uploadNext(i+1));
                };
                uploadNext(0);
            }
        }

        function clearForm() {
            for(let i=0; i<5; i++) document.getElementById(`input-${i}`).value = '';
            focusField(0);
        }

        // Init
        focusField(0);
        updateOfflineUI();

    </script>
</body>
</html>
